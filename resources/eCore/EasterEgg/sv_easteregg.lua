local cfg_EasterEgg = {}

cfg_EasterEgg.locale = 'fr'

cfg_EasterEgg.texts = {
  ['fr'] = {
    collected = '~p~Figurine de collection assemblée',
    collected_all = 'Vous avez récupéré toutes les figurines de collection !'
  },
}

cfg_EasterEgg.advanceCount = true -- Compter à l'avance, car on m'a dit que c'est parfois dupé cette merde

cfg_EasterEgg.rotations = {
  {0.0, 0.0, 9.0}, 
  {0.0, 0.0, -1.0},
  {0.0, 0.0, -1.0}, 
  {0.0, 0.0, -166.0}, -- rota
  {0.0, 0.0, -91.0}, --rota
  {0.0, 0.0, -91.0}, --rota
  {0.0, 0.0, -6.0},
  {0.0, 0.0, 24.0},
  {0.0, 0.0, 49.0},
  {0.0, 0.0, 79.0},
  {0.0, 0.0, 89.0},
  {0.0, 0.0, 24.0},
  {0.0, 0.0, 149.0},
  {0.0, 0.0, 49.0},
  {0.0, 0.0, 0.0},
  {0.0, 0.0, 44.0},
  {0.0, 0.0, 154.0},
  {0.0, 0.0, -46.0},
  {0.0, 0.0, -105.0},
  {0.0, 0.0, -141.0},
  {0.0, 0.0, 134.0},
  {0.0, 0.0, -146.0},
  {0.0, 0.0, -141.0},
  {0.0, 0.0, 170.998},
  {0.0, 0.0, -61.0},
  {0.0, 0.0, 129.0},
  {0.0, 0.0, -127.04},
  {0.0, 0.0, -22.39},
  {0.0, 0.0, 77.24},
  {0.0, 0.0, -23.15},
  {0.0, 0.0, 43.89},
  {0.0, 0.0, -126.21},
  {0.0, 0.0, 43.89},
  {0.0, 0.0, 33.96},
  {0.0, 0.0, -103.58},
  {0.0, 0.0, -21.98},
  {0.0, 0.0, 135.16},
  {0.0, 0.0, 135.16},
  {0.0, 0.0, -119.39},
  {0.0, 0.0, -73.66},
  {0.0, 0.0, -39.16},
  {0.0, 0.0, 43.51},
  {0.0, 0.0, -43.35},
  {0.0, 0.0, 157.73},
  {0.0, 0.0, 110.76},
  {0.0, 0.0, -64.86},
  {0.0, 0.0, 93.23},
  {0.0, 0.0, -15.62},
  {0.0, 0.0, 141.55},
  {0.0, 0.0, -73.48},
}

cfg_EasterEgg.coords = {
  {3311.56, 7170.46, 9.18}, --good
  {3322.672, 7320.092, 21.2141628}, --good
  {2529.11, 7148.55, 14.78}, --good
  {2490.2002, 6431.25928, 14.2802143}, -- rota
  {2303.86157, 6018.53174, 4.73355341}, --rota
  {2100.99438, 5925.818, 9.207714}, --rota
  {2357.32544, 5683.78271, 27.1777534},
  {2085.75928, 5502.108, 20.66249},
  {2224.799, 5348.989, 15.9203787},
  {2343.26953, 5164.844, 12.7573147},
  {2550.8667, 4977.88037, 14.2303238},
  {2293.53687, 4815.25537, 11.460906},
  {2014.503, 4962.421, 12.8276358},
  --{1951.92053, 6379.192, 9.414029},
  {2165.91016, 6562.067, -8.427339},
  {2408.56543, 7693.41, 10.2077446},
  {2857.8667, 7166.38867, 9.025577},
  {2603.198, 7066.423, 20.2621288},
  {2539.03052, 4623.29541, 10.453126}, ------
  {2761.038, 7411.573, 5.509042},
  {2415.81445, 7320.82959, 10.3752041},
  {2454.3457, 6659.66553, 9.064645},
  {2350.03442, 6284.764, 13.9076195},
  {2394.953, 5289.455, 9.065974},
  {2290.52, 5684.144, 8.92969},
  {2701.10767, 5650.749, 8.664843},
  {3710.28564, 5715.1626, 32.01737},
  {3610.126, 5522.769, 16.257988},
  {3570.94385, 5354.66748, 9.030621},
  {3384.11987, 4661.847, 9.021384},
  {3091.30225, 4847.27734, 9.123539},
  {3241.53418, 4768.66553, 8.414588},
  {3281.15723, 5119.031, 8.419172},
  {3332.48145, 5308.494, 9.031616},
  {3496.487, 5459.17529, 8.104893},
  {3549.455, 5605.58643, 8.104893},
  {3529.78271, 6475.695, 11.483614},
  {3655.63037, 6575.383, 9.03220749},
  {3569.624, 6672.268, 9.958313},
  {3517.626, 7138.099, 8.590599},
  {3812.126, 7311.323, 13.901577},
  {3844.66187, 6897.576, 90.91662},
  {3757.73535, 6768.782, 9.661097},
  {3341.3147, 6472.96533, 20.5539589},
  {3188.674, 6302.48633, 8.950446},
  {3290.90942, 6055.9165, 10.34485},
  {3494.85742, 6233.29932, 9.619963},
  {3484.206, 6007.431, 9.792067},
  {3589.65674, 5934.666, 18.5420513},
  {3517.13135, 5730.728, 9.185},
}

cfg_EasterEgg.models = {
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
  'vw_prop_vw_colle_rsrgeneric',
}

-- Désolé mais j'avait la flemme 
local pickups = {}
for k,v in pairs(cfg_EasterEgg.coords) do
  pickups[k] = {GetHashKey(cfg_EasterEgg.models[k]), v, cfg_EasterEgg.rotations[k]}
end

-- Initialiser les stats des joueurs
local stats_data = LoadResourceFile(GetCurrentResourceName(), 'stats.json')
local stats = {}
if stats_data then
  stats = json.decode(stats_data)
end

-- Analyser les stats
if cfg_EasterEgg.advanceCount then
  for k,v in pairs(stats) do
    local count = 0
    for i,d in pairs(v.pickups) do
      count = count + 1
    end

    v.count = count
  end
end

-- Obtenir une licence
local function GetPlayerLicense(ids)
  for _,v in pairs(ids) do
    if string.find(v, 'license') then
      return v
    end
  end

  return false
end

-- Évent de ramassage
RegisterNetEvent('Extasy:takePuckup')
AddEventHandler('Extasy:takePuckup', function(token, pickupId)
  if not CheckToken(token, source, "Extasy:takePuckup") then return end	
  local ids = GetPlayerIdentifiers(source)
  local license = GetPlayerLicense(ids)
  local data = stats[license]

  if not data then
    stats[license] = {
      count = 0,
      pickups = {}
    }
  end

  stats[license].pickups[pickupId] = true

  if cfg_EasterEgg.advanceCount then
    local count = 0
    for i,d in pairs(stats[license].pickups) do
      count = count + 1
    end

    stats[license].count = count
  else
    stats[license].count = stats[license].count + 1
  end

  if stats[license].count == #cfg_EasterEgg.coords then
    TriggerClientEvent('EG:Notification', source, cfg_EasterEgg.texts[cfg_EasterEgg.locale].collected_all)
    TriggerEvent('Extasy:collectedAllFigures', source)
  else
    TriggerClientEvent('EG:Notification', source, cfg_EasterEgg.texts[cfg_EasterEgg.locale].collected..' (~p~'..stats[license].count..'/'..#cfg_EasterEgg.coords..')~s~')
  end

  SaveResourceFile(GetCurrentResourceName(), 'stats.json', json.encode(stats), -1)
end)

-- Le joueur demande ses propres données
RegisterNetEvent('Extasy:requestData')
AddEventHandler('Extasy:requestData', function()
  local ids = GetPlayerIdentifiers(source)
  local license = GetPlayerLicense(ids)
  if license then
    local data = stats[license] or {
      count = 0,
      pickups = {}
    }
    TriggerClientEvent('Extasy:receiveData', source, data, pickups)
  else
    print('WHAAAT, LE JOUEUR A PAS DE LICENCE, SOURCE: '..source)
  end
end)

-- Exemple d'événement de récompense
AddEventHandler('Extasy:collectedAllFigures', function(token, playerSource)
  if not CheckToken(token, source, "Extasy:collectedAllFigures") then return end

  local msg = ""
    if EasterEgg then
      msg = "Le joueur ["..playerSource.."] a récupérer les **100 figurines** (Easter Egg) !"
    else
      msg = "Le joueur ["..playerSource.."] a récupérer les **100 figurines** (Easter Egg) !"
    end

    local discordInfo = {
          ["color"] = "15158332",
          ["type"] = "rich",
          ["title"] = "Easter Egg",
          ["description"] = msg,
          ["footer"] = {
          ["text"] = '90Life - EasterEgg'
          }
      }

    PerformHttpRequest(extasy_sv_core_cfg["webhook_easter_egg"], function(err, text, headers) end, 'POST', json.encode({ username = '90Life - Easter Egg', embeds = { discordInfo } }), { ['Content-Type'] = 'application/json' })
end)